<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>박스오피스</title>
    <link rel="stylesheet" href="css/reset.css"/>
    <link rel="stylesheet" href="css/font-awesome.min.css" />
    <link href='css/notosanskr.css' rel='stylesheet'/>
    <style>
        html {
            overflow-y: scroll;
        }
        body {
            font-family: 'Noto Sans KR',sans-serif;
            color:#424242;
        }
        #header,#footer {
            width:100%;
            height:80px;
        }
        #header {
            border-bottom:1px solid #F12E62;
        }
        #header h1 {
            color:#F12E62;
            font-size:30px;
            font-weight: 900;
            position: absolute;
            top:15px;
            height:50px;
        }
        #header h1 span {
            vertical-align: middle;
        }
        #header h1 img {
            vertical-align: middle;
        }
        #footer {
            border-top:1px solid #F12E62;
            text-align: center;
            line-height:80px;
            color:#F12E62;
        }
        #content {
            min-height:400px;
        }
        .aux {
            position: relative;
            width:1000px;
            margin:auto;
        }
        #dateBox {
            width:300px;
            height:80px;
            line-height: 80px;
            position: absolute;
            right:0;
            top:0;
            color:#626262;
        }
        #dateBox select {
            padding:4px 12px;
            font:500 20px 'Noto Sans KR',sans-serif;
            color:#bbb;
            border:1px solid #bbb;
            outline:none;
        }
        #dateBox select:focus {
            color:#F12E62;
            border-color:#F12E62;
        }
        #content h2 {
            text-align: center;
            font-size:25px;
            font-weight: 700;
            padding:20px;
            color:#F12E62;
        }

        #movieList {
            overflow: hidden;
            padding: 10px 0;
        }
        #movieList li {
            width:326px;
            height:118px;
            background: #FCE4EC;
            float:left;
            margin-right:8px;
            margin-bottom:8px;
            border:1px solid #F8BBD0;
            overflow: hidden;
            position: relative;
        }
        #movieList li.new::before {
            content: 'new';
            position: absolute;
            background: #E91E63;
            color:#fff;
            width: 100px;
            height:24px;
            font-size:15px;
            text-align: center;
            line-height: 24px;
            transform:rotate(-45deg);
            left:-37px;
            z-index:1;
            box-shadow: 0 0 4px #fff;
            box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.16), 0 2px 10px 0 rgba(0, 0, 0, 0.12);
        }

        #movieList h3 {
            position: absolute;
            font-size:22px;
            left:20px;
            top:20px;
            font-weight:700;
            white-space: nowrap;
            overflow: hidden;
            width:295px;
            text-overflow: ellipsis;
        }
        #movieList h3 strong {
            background: #F12E62;
            color:#fff;
            font-weight:900;
            padding:4px 10px;
            display: inline-block;
            vertical-align: middle;
        }
        #movieList h3 span {
            vertical-align: middle;
        }
        #movieList time {
            position: absolute;
            left:20px;
            bottom:20px;
            font-size:15px;
            font-weight:100;
        }
        #movieList em {
            position: absolute;
            right:20px;
            bottom: 20px;
            font-size:20px;
            font-weight:500;
        }
        #movieList em span {
            font-size:18px;
            font-weight:300;
        }

        #movieList li:nth-child(3n) {
            margin-right:0;
        }

        #loader {
            width:100%;
            height:100%;
            left:0;
            top:0;
            position: fixed;
            background: rgba(255, 255, 255, .8) url(img/loader2.gif) no-repeat center;
            display: none;
            z-index: 100;
        }


    </style>
</head>
<body>
<header id="header">
    <div class="aux">
        <h1>
            <img src="img/logo.png" width="50"/>
            <span>박스오피스</span>
        </h1>
        <div id="dateBox">
            <select id="year" name="year">
            </select>
            년
            <select id="month" name="month">
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
            </select>
            월
            <select id="date" name="date">
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
            </select>
            일
        </div>
    </div>
</header>
<main id="content">
    <div class="aux">
        <h2>2017년 11월 10일 박스오피스</h2>
        <ul id="movieList">

        </ul>
    </div>
</main>
<footer id="footer">
    <div class="aux">
        &copy; 2017 jbm.com
    </div>
</footer>
<div id="loader"></div>
<!-- underscore템플릿 -->
<script type="text/template" id="movieTmp">
    <% _.each(movies,function(movie) {
    var className = "old";
    if(movie.rankOldAndNew=="NEW") {
        className = "new";
    }
    %>
    <li class="<%=className%>">
        <h3><strong><%=movie.rank%></strong>
            <span><%=movie.movieNm%></span>
        </h3>
        <time><%=moment(movie.openDt).format("YYYY년 M월 D일")%></time>
        <em><%=numberWithCommas(movie.audiAcc)%><span>명</span></em>
    </li>
    <% })%>
</script>
<script src="js/jquery.js"></script>
<script src="js/moment-with-locales.js"></script>
<script src="js/underscore-min.js"></script>
<script>
    function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }


    //영화진흥위원회 Open API 주소
    var url =
        "http://www.kobis.or.kr/kobisopenapi/webservice/rest/boxoffice/searchDailyBoxOfficeList.json?key=430156241533f1d058c603178cc3ca0e&targetDt=";

    var $loader = $("#loader");

    var $year = $("#year"),
        $month = $("#month"),
        $date = $("#date");

    var now = moment();

    //년과 월을 만드는 함수(한 번)
    function createSelect() {

        var year = $year.val();
        console.log($year.children().find(":last"));

        if($year.children().length==0) {

            $year.empty();

            //moment 라이브러리를 이용해서 현재년도를 얻어옴
            var nowYear = moment().year();
            //alert(nowYear);

            //2) 올해부터 110년전까지
            for(var i = nowYear ; i > nowYear-14 ; i--) {

                $("<option>").text(i).appendTo("#year");


            }//for end
            flag = false;

        }

        if($month.children().length==0 || $month.children().length!=12  || year==now.year()) {

            var oldMonth = $month.val();

            $month.empty();
            var month = 12;

            if($year.val()==now.year()) {
                month = now.month()+1;
            }
            //1) 1~12월을 생성후 append
            for( var i = 1 ; i <= month ; i++) {
                var $option = $("<option>").text(i).appendTo("#month");
                if(oldMonth==i) {
                    $option.prop("selected",true);
                }
            }//for end
        }

        var oldDate = $date.val();
        $date.empty();

        //2) 유저가 선택한 월
        var month = $("#month").val();

        //3) moment라이브러리가 가지고 있는 endOf를 이용하여 해당월의 마지막 일을
        //얻어옴
        var endDay =  moment(year+"-"+month).endOf('month').date();

        if(year==now.year() && month == now.month()+1) {
            endDay = now.date()-1;
        }

        //4) for문을 이용해서 id가 date인 select요소에 option객체를 append
        for( var i = 1 ; i <= endDay ; i++ ) {
            var $option = $("<option>").text(i).appendTo("#date");
            if(oldDate==i) {
                $option.prop("selected",true);
            }
        }//for end

        getMovies();

    }//createSelect() end

    //한번만 호출
    createSelect();

    $year.change(createSelect);
    $month.change(createSelect);
    $date.change(getMovies);

    function getMovies() {

        //년도 얻어옴
        year = $year.val();

        //월 얻어옴
        month = $month.val();

        date = $date.val();

        $("h2").text(year+"년 "+month+"월 "+date+"일 박스오피스");

        $loader.show();

        if(month<10) {
            month = "0"+month;
        }
        if(date<10) {
            date = "0"+date;
        }

        url+year+month+date;


        console.log(url+year+month+date);
//
        $.ajax(url+year+month+date,{
            type:"get",
            data:{itemPerPage:9},
            error:function(xhr,error,code) {
                alert(error);
            },
            success:function(json) {

                console.log(json);

                var movies = json.boxOfficeResult.dailyBoxOfficeList;

                $(movies).each(function() {
                    console.log(this.rankOldAndNew);
                })

                $("#movieList").empty();

                var tmp = _.template($("#movieTmp").html());

                var markup = tmp({movies:movies});

                $("#movieList").prepend(markup);


                $loader.hide();

            }//success end

        });//$.ajax() end

    }


</script>
</body>
</html>